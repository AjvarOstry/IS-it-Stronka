<!DOCTYPE html>
<html lang="pl-PL">
<head>
  <meta charset="utf-8">
  <title>IS-it-notateczki</title>
  <link rel="stylesheet" href="./styles/structure.min.css">
  <link rel="stylesheet" href="./styles/design.min.css">
  <link rel="stylesheet" href="./styles/markdown.min.css">

  <!-- KaTeX dla wzorów matematycznych -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
  <!-- Automatyczne renderowanie KaTeX -->
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"></script>

  <!-- Highlight.js z motywem Monokai -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/monokai.min.css">

  <!-- Lokalny Marked -->
  <script src="./scripts/marked.min.js" onload="onMarkedLoaded()" onerror="console.error('Failed to load local Marked')"></script>
  <script src="./scripts/emojiMap.js"></script>
</head>

<body>
  <header>
    <h1>IS it?</h1>
  </header>
  
  <section>
    <nav class="box">
      <ul class="menu">
        <li><a href="#" data-md-file="docs/main.md"> > Strona główna</a></li>
        <hr>
        <li>Semestr 1</li>
        <li class="ma-podmenu">
          <a href="#">Semestr 2</a>
          <ul class="podmenu">
            <li><a href="#" data-md-file="./docs/Sem2/git-komendy.md">Git</a></li>
            <li><a href="#" data-md-file="./docs/Sem2/cmake-i-boosttest.md">Cmake+Boosttest</a></li>
            <li><a href="#" data-md-file="docs/Sem2/sysodpowiedzi4.md">SysOdpowiedzi 4</a></li>
          </ul>
        </li>
        <li>Semestr 3</li>
        <hr>
        <li class="ma-podmenu">
          <a href="#">Różne takie</a>
          <ul class="podmenu">
            <li><a href="#" data-md-file="./docs/test-markdown.md">Testy</a></li>
          </ul>
        </li>
      </ul>
    </nav>
    <article id="md-screen" class="box"></article>
  </section>

  <!-- JavaScript na końcu body, aby DOM był załadowany -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script>
    // Funkcja wywoływana po załadowaniu Marked
    function onMarkedLoaded() {
      window.markedLoaded = true;
      configureMarked();
    }

    // Funkcja zamiany shortcodes na emoji
    function renderEmojis(text) {
      return text.replace(/:[a-zA-Z0-9_-]+:/g, match => window.emojiMap[match] || match);
    }

    // Konfiguracja Marked z rendererem dla checkboxów
    const renderer = new marked.Renderer();
    renderer.checkbox = function (checked) {
      return `<input type="checkbox" ${checked ? 'checked' : ''}>`;
    };

    function configureMarked() {
      if (typeof hljs !== 'undefined' && typeof marked !== 'undefined' && window.markedLoaded) {
        marked.setOptions({
          gfm: true,
          breaks: true,
          renderer: renderer,
          highlight: function (code, lang) {
            const language = hljs.getLanguage(lang) ? lang : 'plaintext';
            return hljs.highlight(code, { language }).value;
          },
        });
      } else {
        console.warn('highlight.js lub marked nie załadowały się poprawnie. Niektóre funkcje mogą nie działać.');
        if (!window.markedLoaded) {
          console.error('Marked nie załadował się. Sprawdź plik lokalny.');
          document.getElementById('md-screen').innerHTML = '<p>Błąd: Nie można załadować biblioteki Marked.</p>';
          return;
        }
        marked.setOptions({
          gfm: true,
          breaks: true,
          renderer: renderer,
        });
      }
      loadMarkdown('docs/main.md');
    }

    // Funkcja do wczytywania Markdown i renderowania wzorów
    let currentFile = '';
    let currentMarkdown = '';

    function loadMarkdown(file) {
      currentFile = file; // Ustawiamy currentFile przed użyciem
      fetch(file)
        .then(response => {
          if (!response.ok) throw new Error('Nie można wczytać pliku');
          return response.text();
        })
        .then(text => {
          currentMarkdown = text;
          const renderedText = renderEmojis(marked.parse(text));
          document.getElementById('md-screen').innerHTML = renderedText;
          if (typeof hljs !== 'undefined') {
            document.querySelectorAll('#md-screen pre code').forEach(block => {
              hljs.highlightElement(block);
            });
          }
          // Renderowanie wzorów matematycznych za pomocą KaTeX
          if (typeof renderMathInElement !== 'undefined') {
            renderMathInElement(document.getElementById('md-screen'), {
              delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\[", right: "\\]", display: true },
                { left: "\\(", right: "\\)", display: false }
              ],
              throwOnError: false
            });
          }
          addCheckboxInteractivity();
        })
        .catch(error => {
          document.getElementById('md-screen').innerHTML = `<p>Błąd: ${error.message}</p>`;
        });
    }

    // Funkcja dodająca interaktywność checkboxom
    function addCheckboxInteractivity() {
      const checkboxes = document.querySelectorAll('#md-screen input[type="checkbox"]');
      checkboxes.forEach((checkbox, index) => {
        checkbox.setAttribute('data-index', index);
        checkbox.addEventListener('change', (e) => {
          const idx = parseInt(e.target.getAttribute('data-index'));
          updateMarkdownCheckbox(idx, e.target.checked);
        });
        const li = checkbox.parentElement;
        li.addEventListener('click', (e) => {
          if (e.target !== checkbox) {
            checkbox.checked = !checkbox.checked;
            const idx = parseInt(checkbox.getAttribute('data-index'));
            updateMarkdownCheckbox(idx, checkbox.checked);
          }
        });
      });
    }

    // Funkcja aktualizująca Markdown po zmianie stanu checkboxa
    function updateMarkdownCheckbox(index, checked) {
      const lines = currentMarkdown.split('\n');
      let checkboxCount = -1;

      for (let i = 0; i < lines.length; i++) {
        if (lines[i].match(/-\s*\[.\]/)) {
          checkboxCount++;
          if (checkboxCount === index) {
            lines[i] = lines[i].replace(/\[.\]/, checked ? '[x]' : '[ ]');
            break;
          }
        }
      }

      currentMarkdown = lines.join('\n');
      const renderedText = renderEmojis(marked.parse(currentMarkdown));
      document.getElementById('md-screen').innerHTML = renderedText;
      if (typeof hljs !== 'undefined') {
        document.querySelectorAll('#md-screen pre code').forEach(block => {
          hljs.highlightElement(block);
        });
      }
      if (typeof renderMathInElement !== 'undefined') {
        renderMathInElement(document.getElementById('md-screen'), {
          delimiters: [
            { left: "$$", right: "$$", display: true },
            { left: "$", right: "$", display: false },
            { left: "\\[", right: "\\]", display: true },
            { left: "\\(", right: "\\)", display: false }
          ],
          throwOnError: false
        });
      }
      addCheckboxInteractivity();
    }

    // Inicjalizacja po załadowaniu DOM
    document.addEventListener('DOMContentLoaded', () => {
      // Upewniamy się, że Marked się załadowało, zanim wykonamy configureMarked
      if (!window.markedLoaded) {
        console.warn('Marked nie załadował się od razu. Czekamy...');
        setTimeout(() => {
          if (typeof marked !== 'undefined') {
            window.markedLoaded = true;
            configureMarked();
          } else {
            console.error('Marked nadal nie załadowany. Sprawdź plik lokalny.');
            document.getElementById('md-screen').innerHTML = '<p>Błąd: Nie można załadować biblioteki Marked.</p>';
          }
        }, 1000); // Czekamy 1 sekundę na załadowanie
      } else {
        configureMarked();
      }
      const links = document.querySelectorAll('.menu a[data-md-file]');
      links.forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const mdFile = link.getAttribute('data-md-file');
          loadMarkdown(mdFile);
        });
      });
    });
  </script>
</body>
</html>